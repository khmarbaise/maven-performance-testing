<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExecuteMeasurement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Maven Performance Testing</a> &gt; <a href="index.source.html" class="el_package">com.soebes.maven.performance</a> &gt; <span class="el_source">ExecuteMeasurement.java</span></div><h1>ExecuteMeasurement.java</h1><pre class="source lang-java linenums">package com.soebes.maven.performance;

import com.soebes.maven.performance.execution.ExecuteCommand;
import com.soebes.maven.performance.execution.ExecutionResult;

import java.io.IOException;
import java.nio.file.FileSystems;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.util.List;

public class ExecuteMeasurement {

  private Integer numberOfModules;
  private List&lt;Path&gt; jdkVersions;

<span class="nc" id="L19">  public ExecuteMeasurement(Integer numberOfModules, List&lt;Path&gt; jdkVersions) {</span>
<span class="nc" id="L20">    this.numberOfModules = numberOfModules;</span>
<span class="nc" id="L21">    this.jdkVersions = jdkVersions;</span>
<span class="nc" id="L22">  }</span>

  public void measurement() {
<span class="nc" id="L25">    jdkVersions.forEach(jdk -&gt; cmdExecute(numberOfModules, jdk));</span>
<span class="nc" id="L26">  }</span>

  void cmdExecute(Integer numberOfModules, Path jdkVersion) {

<span class="nc" id="L30">    System.out.println(&quot;Executing measurement for numberOfModules = &quot; + numberOfModules + &quot; with:&quot; + jdkVersion.getFileName());</span>

<span class="nc" id="L32">    Path basePath = Path.of(&quot;target&quot;, &quot;scenarios&quot;);</span>
    // -w 5 warmup round 5
    // --export-markdown ../src/site/markdown/results-${JDK}.md -L VERSION &quot;${VERSIONS[*]}&quot; -n {VERSION} ../apache-maven-{VERSION}/bin/mvn clean )
<span class="nc" id="L35">    String versions = &quot;3.0.5,3.1.1,3.2.5,3.3.9,3.5.4,3.6.3,3.8.1,3.8.2,3.8.3,3.8.4,3.8.4,3.8.6,4.0.0-alpha-1&quot;;</span>
<span class="nc" id="L36">    String result = String.format(&quot;results-%s-%s.md&quot;, jdkVersion.getFileName(), numberOfModules);</span>
<span class="nc" id="L37">    String resultJson = String.format(&quot;results-%s-%s.json&quot;, jdkVersion.getFileName(), numberOfModules);</span>
<span class="nc" id="L38">    String moduleDirectory = String.format(&quot;number-of-module-%04d&quot;, numberOfModules);</span>
<span class="nc" id="L39">    Path rootTestDirectory = FileSystems.getDefault().getPath(&quot;&quot;).toAbsolutePath();</span>
<span class="nc" id="L40">    Path downloadsDirectory = rootTestDirectory.resolve(&quot;downloads&quot;);</span>
<span class="nc" id="L41">    Path markdownDirectory = rootTestDirectory.resolve(&quot;src&quot;).resolve(&quot;site&quot;).resolve(&quot;markdown&quot;);</span>

<span class="nc" id="L43">    String prepareCommand = &quot;JAVA_HOME=&quot; + jdkVersion.toString();</span>

    //Need to reconsider if using .mavenrc is a good idea?
    //Heap setting for all tests the same!
<span class="nc" id="L47">    writeMavenRc();</span>
<span class="nc" id="L48">    String commandToExecute = downloadsDirectory + &quot;/apache-maven-{VERSION}/bin/mvn -V clean | tee mvn-{VERSION}-&quot; + jdkVersion.getFileName() + &quot;.log 2&gt;mvn-{VERSION}-&quot; + jdkVersion.getFileName() + &quot;-error.log&quot;;</span>
<span class="nc" id="L49">    ExecuteCommand executeCommand = new ExecuteCommand();</span>

<span class="nc" id="L51">    ExecutionResult exec = executeCommand.exec(List.of(&quot;hyperfine&quot;), List.of(&quot;-w&quot;, &quot;5&quot;, &quot;--export-markdown&quot;, markdownDirectory + &quot;/&quot; + result,</span>
            &quot;--export-json&quot;, markdownDirectory + &quot;/&quot; + resultJson,
            &quot;--shell&quot;, &quot;bash&quot;,
//            &quot;-p&quot;, prepareCommand,
<span class="nc" id="L55">            &quot;-L&quot;, &quot;VERSION&quot;, versions, &quot;-n&quot;, &quot;{VERSION}&quot;, prepareCommand + &quot;;&quot; + commandToExecute), Paths.get(basePath.toString(), moduleDirectory).toFile()</span>
    );
<span class="nc" id="L57">    System.out.println(exec.getStdErr());</span>
<span class="nc" id="L58">    System.out.println(exec.getStdOut());</span>
<span class="nc" id="L59">    System.out.println(&quot;exec = &quot; + exec.getReturnCode());</span>
<span class="nc" id="L60">  }</span>


  void writeMavenRc() {
<span class="nc" id="L64">    String javaOpts = &quot;export JAVA_OPTS=-Xmx12G&quot;;</span>
    //FIXME: Home directory hard coded.
    try {
<span class="nc" id="L67">      Files.writeString(Path.of(&quot;/home&quot;, &quot;tmpt&quot;).resolve(&quot;.mavenrc&quot;), javaOpts, StandardOpenOption.CREATE);</span>
<span class="nc" id="L68">    } catch (IOException e) {</span>
<span class="nc" id="L69">      e.printStackTrace();</span>
<span class="nc" id="L70">    }</span>
<span class="nc" id="L71">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>